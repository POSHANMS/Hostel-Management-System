<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Hostel Management</title>
  <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸ“ Student Portal</h2>
      <p id="studentName">Student</p>
    </div>
    <ul class="sidebar-menu">
      <li><a href="dashboard.html" class="active">ğŸ“Š Dashboard</a></li>
      <li><a href="profile.html">ğŸ‘¤ My Profile</a></li>
      <li><a href="room-details.html">ğŸ  Room Details</a></li>
      <li><a href="payment-details.html">ğŸ’° Payments</a></li>
      <li><a href="submit-complaint.html">ğŸ“ Complaints</a></li>
    </ul>
    <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
  </div>

  <div class="main-content">
    <div class="page-header">
      <h1>Welcome, <span id="welcomeName">Student</span>!</h1>
      <p>Here's your hostel information</p>
    </div>

    <div id="alert" class="alert"></div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-details">
          <h3 id="roomNumber">-</h3>
          <p>Room Number</p>
        </div>
        <div class="stat-icon blue">ğŸ </div>
      </div>

      <div class="stat-card">
        <div class="stat-details">
          <h3 id="monthlyRent">â‚¹0</h3>
          <p>Monthly Rent</p>
        </div>
        <div class="stat-icon green">ğŸ’°</div>
      </div>

      <div class="stat-card">
        <div class="stat-details">
          <h3 id="pendingPayments">0</h3>
          <p>Pending Payments</p>
        </div>
        <div class="stat-icon orange">ğŸ“…</div>
      </div>

      <div class="stat-card">
        <div class="stat-details">
          <h3 id="activeComplaints">0</h3>
          <p>Active Complaints</p>
        </div>
        <div class="stat-icon red">ğŸ“</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <h2>Room Information</h2>
        </div>
        <div class="card-body">
          <div class="info-item">
            <strong>Room Number:</strong>
            <span id="roomInfo">Not Assigned</span>
          </div>
          <div class="info-item">
            <strong>Room Type:</strong>
            <span id="roomType">-</span>
          </div>
          <div class="info-item">
            <strong>Floor:</strong>
            <span id="floor">-</span>
          </div>
          <div class="info-item">
            <strong>Facilities:</strong>
            <span id="facilities">-</span>
          </div>
          <div class="info-item">
            <strong>Allotment Date:</strong>
            <span id="allotmentDate">-</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Recent Payments</h2>
        </div>
        <div class="card-body">
          <div id="recentPayments">
            <p style="text-align: center; color: #999;">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>Recent Complaints</h2>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Subject</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="complaintsTable">
              <tr>
                <td colspan="4" style="text-align: center;">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    
    // âœ… WORKS WITH YOUR ORIGINAL LOGIN
    const studentId = localStorage.getItem('studentId');
    const token = localStorage.getItem('token');

    if (!studentId || !token) {
      window.location.href = '../login.html';
    }

    async function loadDashboard() {
      try {
        // Load profile
        const profileResponse = await fetch(`${API_URL}/student/profile/${studentId}`);
        const profileData = await profileResponse.json();

        if (profileData.success && profileData.student) {
          document.getElementById('studentName').textContent = profileData.student.full_name;
          document.getElementById('welcomeName').textContent = profileData.student.full_name;
        }

        // Load room details
        const roomResponse = await fetch(`${API_URL}/student/room-details/${studentId}`);
        const roomData = await roomResponse.json();

        console.log('Room data:', roomData);

        if (roomData.success && roomData.room) {
          document.getElementById('roomNumber').textContent = roomData.room.room_number || '-';
          document.getElementById('roomInfo').textContent = roomData.room.room_number || '-';
          document.getElementById('roomType').textContent = roomData.room.room_type || '-';
          document.getElementById('floor').textContent = roomData.room.floor || '-';
          document.getElementById('facilities').textContent = 'AC, WiFi, Study Table, Bed';
          document.getElementById('allotmentDate').textContent = formatDate(roomData.room.created_at);
          document.getElementById('monthlyRent').textContent = 'â‚¹' + (roomData.room.rent || 0);
        } else {
          document.getElementById('roomNumber').textContent = 'Not Assigned';
          document.getElementById('roomInfo').textContent = 'No room assigned yet';
        }

        // Load payments
        const paymentsResponse = await fetch(`${API_URL}/student/payments/${studentId}`);
        const paymentsData = await paymentsResponse.json();

        console.log('Payments data:', paymentsData);

        if (paymentsData.success && paymentsData.payments) {
          const pending = paymentsData.payments.filter(p => p.status === 'Pending' || p.status === 'Overdue').length;
          document.getElementById('pendingPayments').textContent = pending;

          const recentDiv = document.getElementById('recentPayments');
          if (paymentsData.payments.length > 0) {
            recentDiv.innerHTML = paymentsData.payments.slice(0, 3).map(payment => `
              <div class="info-item">
                <strong>${payment.month} ${payment.year}:</strong>
                <span class="badge badge-${payment.status === 'Paid' ? 'success' : 'warning'}">
                  â‚¹${payment.amount} - ${payment.status}
                </span>
              </div>
            `).join('');
          } else {
            recentDiv.innerHTML = '<p style="text-align: center; color: #999;">No payment records</p>';
          }
        }

        // Load complaints
        const complaintsResponse = await fetch(`${API_URL}/student/complaints/${studentId}`);
        const complaintsData = await complaintsResponse.json();

        console.log('Complaints data:', complaintsData);

        if (complaintsData.success && complaintsData.complaints) {
          const active = complaintsData.complaints.filter(c => c.status !== 'Resolved').length;
          document.getElementById('activeComplaints').textContent = active;

          const tbody = document.getElementById('complaintsTable');
          if (complaintsData.complaints.length > 0) {
            tbody.innerHTML = complaintsData.complaints.slice(0, 5).map(complaint => `
              <tr>
                <td>${formatDate(complaint.created_at)}</td>
                <td>${complaint.category || 'General'}</td>
                <td>${complaint.title}</td>
                <td>
                  <span class="badge badge-${
                    complaint.status === 'Resolved' ? 'success' :
                    complaint.status === 'In Progress' ? 'warning' : 'danger'
                  }">${complaint.status}</span>
                </td>
              </tr>
            `).join('');
          } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No complaints submitted</td></tr>';
          }
        }

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showAlert('Error loading dashboard data', 'error');
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN');
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
      setTimeout(() => alert.classList.remove('show'), 3000);
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../login.html';
    }

    loadDashboard();
  </script>

  <style>
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .info-item:last-child {
      border-bottom: none;
    }
  </style>
</body>
</html>
